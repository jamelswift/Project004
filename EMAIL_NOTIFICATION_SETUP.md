# ЁЯУз р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Ьр╣Ир╕▓р╕Щр╕нр╕╡р╣Ар╕бр╕е (Email Notification Setup)

## тЬи р╕Др╕╕р╕Ур╕кр╕бр╕Ър╕▒р╕Хр╕┤

- тЬЕ р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╣Ар╕бр╕╖р╣Ир╕нр╕Др╣Ир╕▓р╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣Мр╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф (Threshold)
- тЬЕ р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Юр╕гр╣Йр╕нр╕бр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ
- тЬЕ р╣Бр╕кр╕Фр╕Зр╣Ар╕кр╕╡р╕вр╕Зр╕Бр╕гр╕░р╕Фр╕┤р╣Ир╕З (Bell Sound) р╕Ьр╣Ир╕▓р╕Щ Browser
- тЬЕ р╣Бр╕кр╕Фр╕З Browser Notification р╕Юр╕гр╣Йр╕нр╕б Vibration
- тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ Gmail р╣Бр╕ер╕░ SMTP р╕нр╕╖р╣Ир╕Щр╣Ж

---

## ЁЯЪА р╕зр╕┤р╕Шр╕╡р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓

### 1. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Environment Variables

р╣Бр╕Бр╣Йр╣Др╕Вр╣Др╕Яр╕ер╣М `backend/.env`:

```env
# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
ADMIN_EMAIL=admin@example.com

# Frontend URL (for email links)
FRONTEND_URL=http://localhost:3000
```

### 2. р╕кр╕гр╣Йр╕▓р╕З App Password р╕кр╕│р╕лр╕гр╕▒р╕Ъ Gmail

р╕лр╕▓р╕Бр╣Гр╕Кр╣Й Gmail р╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╕кр╕гр╣Йр╕▓р╕З **App Password**:

1. р╣Др╕Ыр╕Чр╕╡р╣И [Google Account Security](https://myaccount.google.com/security)
2. р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ **2-Step Verification**
3. р╣Др╕Ыр╕Чр╕╡р╣И **App Passwords**
4. р╣Ар╕ер╕╖р╕нр╕Б **Mail** р╣Бр╕ер╕░ **Other (Custom name)**
5. р╕Хр╕▒р╣Йр╕Зр╕Кр╕╖р╣Ир╕нр╕зр╣Ир╕▓ "IoT Notification System"
6. р╕Др╕▒р╕Фр╕ер╕нр╕Б Password р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕бр╕▓р╣Гр╕кр╣Ир╣Гр╕Щ `EMAIL_PASSWORD`

### 3. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Threshold р╣Гр╕лр╣Йр╣Ар╕Ыр╕┤р╕Фр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕нр╕╡р╣Ар╕бр╕е

р╣Др╕Ыр╕Чр╕╡р╣И `/dashboard/alerts` р╣Бр╕ер╕░р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Threshold:

```json
{
  "deviceId": "ESP32_001",
  "sensorType": "temperature",
  "minValue": 15,
  "maxValue": 35,
  "enabled": true,
  "notifyEmail": true,      // тЬЕ р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕нр╕╡р╣Ар╕бр╕е
  "notifyBrowser": true     // тЬЕ р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ Browser Notification
}
```

---

## ЁЯУ▒ р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ

### р╣Ар╕бр╕╖р╣Ир╕нр╕Др╣Ир╕▓р╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣Мр╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф:

1. **ЁЯФФ р╣Ар╕кр╕╡р╕вр╕Зр╕Бр╕гр╕░р╕Фр╕┤р╣Ир╕З (Bell Sound)**
   - р╣Ар╕ер╣Ир╕Щр╣Ар╕кр╕╡р╕вр╕Зр╕Бр╕гр╕░р╕Фр╕┤р╣Ир╕Зр╕Ьр╣Ир╕▓р╕Щ Web Audio API
   - р╕Др╕зр╕▓р╕бр╕Цр╕╡р╣И 800Hz р╣Ар╕Ыр╣Зр╕Щр╣Ар╕зр╕ер╕▓ 0.5 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡

2. **ЁЯУм Browser Notification**
   - р╣Бр╕кр╕Фр╕З notification р╕Ър╕Щр╕лр╕Щр╣Йр╕▓р╕Ир╕н
   - р╕бр╕╡ Vibration pattern (р╕кр╕│р╕лр╕гр╕▒р╕Ъ mobile)
   - `requireInteraction: true` р╕кр╕│р╕лр╕гр╕▒р╕Ъ critical alerts

3. **ЁЯУз Email Notification**
   - р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╣Др╕Ыр╕вр╕▒р╕З `ADMIN_EMAIL`
   - р╕бр╕╡р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ:
     - р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М (Device ID)
     - р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣М
     - р╕Др╣Ир╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ
     - р╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕╡р╣Ир╕Хр╕▒р╣Йр╕Зр╣Др╕зр╣Й
     - р╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕гр╕╕р╕Щр╣Бр╕гр╕З
   - р╕бр╕╡р╕Ыр╕╕р╣Ир╕бр╕ер╕┤р╕Зр╕Бр╣Мр╣Др╕Ыр╕вр╕▒р╕Зр╕лр╕Щр╣Йр╕▓р╕Ир╕▒р╕Фр╕Бр╕▓р╕г

4. **ЁЯТ╛ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤**
   - р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕ер╕З DynamoDB NotificationLogs
   - р╣Бр╕кр╕Фр╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Гр╕Щр╕лр╕Щр╣Йр╕▓ Alerts

---

## ЁЯУК р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ъ

```
р╕лр╕▒р╕зр╕Вр╣Йр╕н: ЁЯЪи р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ: temperature р╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф

тЪая╕П р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Др╣Ир╕▓р╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣Мр╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф

р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М: ESP32_001
р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣М: temperature
р╕Др╣Ир╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ: 38.5
р╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Фр╕Хр╣Ир╕│р╕кр╕╕р╕Ф: 15
р╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Фр╕кр╕╣р╕Зр╕кр╕╕р╕Ф: 35
р╕гр╕░р╕Фр╕▒р╕Ъ: CRITICAL

ЁЯЪи temperature р╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф: р╕Др╣Ир╕▓ 38.5 р╣Ар╕Бр╕┤р╕Щр╕Бр╕зр╣Ир╕▓ 35

[р╕Фр╕╣р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф] --> р╕ер╕┤р╕Зр╕Бр╣Мр╣Др╕Ыр╕вр╕▒р╕З /dashboard/alerts
```

---

## ЁЯОп р╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕гр╕╕р╕Щр╣Бр╕гр╕З (Severity Levels)

| Level | р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В | р╕кр╕╡ | р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ |
|-------|---------|-----|--------------|
| **Critical** | р╣Ар╕Бр╕┤р╕Щ > 50% | ЁЯФ┤ р╣Бр╕Фр╕З | р╕нр╕╡р╣Ар╕бр╕е + р╣Ар╕кр╕╡р╕вр╕З + Vibration |
| **Warning** | р╣Ар╕Бр╕┤р╕Щ 30-50% | ЁЯЯа р╕кр╣Йр╕б | р╕нр╕╡р╣Ар╕бр╕е + р╣Ар╕кр╕╡р╕вр╕З |
| **Info** | р╣Ар╕Бр╕┤р╕Щ < 30% | ЁЯЯб р╣Ар╕лр╕ер╕╖р╕нр╕З | р╣Ар╕кр╕╡р╕вр╕Зр╣Ар╕Ър╕▓ |

---

## ЁЯФз р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ

### 1. р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕е

```bash
cd backend
npm run test-email
```

р╕лр╕гр╕╖р╕нр╣Ар╕гр╕╡р╕вр╕Б API:

```bash
curl -X POST http://localhost:5000/api/notifications/email \
  -H "Content-Type: application/json" \
  -d '{
    "to": "admin@example.com",
    "subject": "Test Alert",
    "message": "This is a test notification"
  }'
```

### 2. р╕Чр╕Фр╕кр╕нр╕Ъ Browser Notification

1. р╣Ар╕Ыр╕┤р╕Ф `/dashboard/control`
2. р╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ (Allow Notifications)
3. р╕кр╕гр╣Йр╕▓р╕З Alert р╕Чр╕Фр╕кр╕нр╕Ъ:

```bash
curl -X POST http://localhost:5000/api/alerts/test \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "ESP32_001",
    "sensorType": "temperature",
    "value": 40,
    "message": "Test threshold alert",
    "level": "critical"
  }'
```

---

## ЁЯРЫ р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

### р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕нр╕╡р╣Ар╕бр╕е

1. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ `EMAIL_USER` р╣Бр╕ер╕░ `EMAIL_PASSWORD` р╣Гр╕Щ `.env`
2. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Гр╕Кр╣Й **App Password** р╕кр╕│р╕лр╕гр╕▒р╕Ъ Gmail (р╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╕Ыр╕Бр╕Хр╕┤)
3. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `ADMIN_EMAIL` р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
4. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Backend logs: `console.log` р╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕зр╣Ир╕▓р╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕лр╕гр╕╖р╕нр╣Др╕бр╣И

### р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕вр╕┤р╕Щр╣Ар╕кр╕╡р╕вр╕Зр╕Бр╕гр╕░р╕Фр╕┤р╣Ир╕З

1. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Ыр╕┤р╕Фр╣Ар╕кр╕╡р╕вр╕З (Mute)
2. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Browser Console р╕бр╕╡ error р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
3. тЬЕ р╕ер╕нр╕З refresh р╕лр╕Щр╣Йр╕▓р╣Бр╕ер╕░р╕нр╕Щр╕╕р╕Нр╕▓р╕Х Notification р╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З

### Browser Notification р╣Др╕бр╣Ир╣Бр╕кр╕Фр╕З

1. тЬЕ р╕нр╕Щр╕╕р╕Нр╕▓р╕Х Notification Permission
2. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╕гр╕нр╕Зр╕гр╕▒р╕Ъ Notification API
3. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Гр╕Щ Browser Settings > Notifications

---

## ЁЯУЪ р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З

```
backend/
тФЬтФАтФА services/
тФВ   тФФтФАтФА email.service.ts         # Email service (sendAlertEmail)
тФФтФАтФА server.ts                    # Threshold checking + Email sending

frontend/
тФЬтФАтФА lib/
тФВ   тФФтФАтФА notifications.ts         # Browser notification + Bell sound
тФФтФАтФА app/dashboard/control/
    тФФтФАтФА page.tsx                 # UI р╣Бр╕кр╕Фр╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ
```

---

## ЁЯТб Tips

1. **р╣Гр╕Кр╣Й Development Mode**:
   - р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Хр╕▒р╣Йр╕З `EMAIL_USER` р╕гр╕░р╕Ър╕Ър╕Ир╕░р╣Бр╕кр╕Фр╕З log р╣Бр╕Чр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Ир╕гр╕┤р╕З

2. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Quiet Hours**:
   - р╕нр╕▓р╕Ир╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╣Ар╕зр╕ер╕▓р╣Др╕бр╣Ир╕кр╣Ир╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ (р╣Ар╕Кр╣Ир╕Щ 22:00-07:00)

3. **Rate Limiting**:
   - р╕гр╕░р╕Ър╕Ър╕Др╕зр╕гр╕бр╕╡р╕Бр╕▓р╕г rate limit р╣Ар╕Юр╕╖р╣Ир╕нр╣Др╕бр╣Ир╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕ер╕Ър╣Ир╕нр╕вр╣Ар╕Бр╕┤р╕Щр╣Др╕Ы

---

## тЬЕ Checklist

- [ ] р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ `EMAIL_USER`, `EMAIL_PASSWORD`, `ADMIN_EMAIL` р╣Гр╕Щ `.env`
- [ ] р╕кр╕гр╣Йр╕▓р╕З App Password р╕кр╕│р╕лр╕гр╕▒р╕Ъ Gmail
- [ ] Restart Backend server
- [ ] р╣Ар╕Ыр╕┤р╕Ф Browser р╣Бр╕ер╕░р╕нр╕Щр╕╕р╕Нр╕▓р╕Х Notification
- [ ] р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Threshold р╕Юр╕гр╣Йр╕нр╕б `notifyEmail: true`
- [ ] р╕Чр╕Фр╕кр╕нр╕Ър╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Лр╣Зр╕Щр╣Ар╕Лр╕нр╕гр╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Щр╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф
- [ ] р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕гр╕▒р╕Ър╕нр╕╡р╣Ар╕бр╕ер╣Бр╕ер╕░р╣Др╕Фр╣Йр╕вр╕┤р╕Щр╣Ар╕кр╕╡р╕вр╕Зр╕Бр╕гр╕░р╕Фр╕┤р╣Ир╕З

---

ЁЯОЙ **р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в!** р╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Бр╕ер╣Йр╕з
